\documentclass[12pt]{article}

\usepackage{hyperref}
\usepackage{tcolorbox}

\newcommand{\loc}[1]{{\bf \fontfamily{pcr}\selectfont #1}}

\newcommand{\todo}[1]{ \begin{tcolorbox} \centering  #1 \end{tcolorbox}}

\newcommand{\key}[3]{{\loc{#1}} (#2) : #3}


\title{UCLA HEDP Experimental Plasma Physics Analysis Package Documentation}
\date{\today}


\begin{document}
\maketitle

\newpage

\tableofcontents

\newpage

\section{Overview}

The UCLA HEDP package first loads 


\section{The Common Data Format (CDF)\label{cdf}}

\subsection{Requirements}

The UCLA HEDP package is designed around a standardized structured data format, hereafter referred to as common data format or CDF. A CDF object is an HDF file that conforms to a standard structure as defined in the function \loc{tools.dataset.validDataset}. In particular, each CDF file must contain

\begin{itemize}

\item A CDF object is a group in an HDF file. It may be the root group, or multiple CDF objects may be housed within a HDF file as separate groups.

\item A dataset called "data" with $n$ dimensions. This array must have an attribute "dimensions" which holds a string array of list $n$ which provides a name for each dimension in the dataset (by convention, all lowercase). A second attribute "unit" defines the units of the data in this array as a string that can by interpreted by the \loc{astropy.units} string-to-unit parser. 

\todo{In the future this could be generalized so that the CDF object could contain multiple data arrays with different names (but all with the same shape and the same axes). This would be conducive to datasets such as density and electron temperature planes from Langmuir measurements which share a set of axes and belong conceptually together. In this case, a new attribute array should be added to the parent group listing the names of all of the data arrays. }

\item For each entry in the "dimensions" attribute there must exist a dataset with the same name which contains the axis values for that dimension. This dataset must also include a mandatory "unit" attribute as defined above.

\item Other attributes (commonly including metadata) are included as attributes of the root group in the HDF file. These entries should be tuples of the form (value, unit) where unit is a unit string as described in the previous points.

\end{itemize}

This format was designed to contain all of the information necessary to make plots of the dataset.

\subsection{Conventions}
\begin{itemize}
\item The convention [shots, time, channels] is commonly used for raw shot-ordered datasets.
\item The convention [time, xaxis, yaxis, zaxis, repetition channel] is commonly used for processed volumetric datasets. 
\end{itemize}

These conventions are chosen to allow easy plotting of subsets of an array. For example, if a dataset has dimensions B = [time, xaxis, yaxis, zaxis, repetition channel]. then it is easy to extract a time trace for a particular position, repetition, and channel B[t] = B[:, x, y, z, r, c] (where x,y,z,r,c represent fixed values for the other axes) or an XY plane B[x,y] = [t, :, :, z, r, c]. 

\subsection{Considerations for Large Datasets}

Large datasets are not stored on consecutive sections of computer memory but are rather broken into "chunks" that are stored separately. Accessing data spread across multiple chunks is much more computationally costly than accessing the same amount of data from a single chunk. The HDF format and the \loc{h5py} package allow control over how a dataset is broken into chunks in order to maximize efficiency. Where possible, the UCLA HEDP package attempts to chunk datasets in a way that minimizes read times for common operations. For example, a dataset containing time arrays at a variety of spatial locations may chose to chunk the time axis together, anticipating that time traces may be accessed more often than large spatial volumes.


\section{The CSV Metadata Format\label{csv_format}}

Metadata is recorded in CSV files in a standard format, and many column header names may be required by different routines in the analysis pipeline. This section describes a number of standard keywords and their usage. 

Across all metadata files the following header format is followed for the top three rows
\begin{enumerate}
\item Machine-readable keywords, eg. "probe", that will become dictionary keys.
\item Unit string, or blank for dimensionless units, eg. "mm2"
\item Human-readable title or note, eg. "Bdot Area". This row is not used by the program but improves readability of the CSV file.
\end{enumerate}

Metadata files are sorted into four types automatically based on whether the csv file includes the "run" or "probe" keywords (Table~\ref{csv_types}). 

\begin{table}[]
\begin{tabular}{p{1cm}p{2cm}p{2cm}p{6cm}}
Type                                 & Has "run" key? & Has "probe" key? & Explanation                                                                          \\ \hline
\multicolumn{1}{c|}{Experiment Data} & No             & No               & Data that pertains to the whole experiment, eg. experiment name, vacuum chamber used \\
\multicolumn{1}{c|}{Run Data}        & Yes            & No               & Data that pertains to a given run number, eg. background field, fill pressure        \\
\multicolumn{1}{c|}{Probe Data}      & No             & Yes              & Data about a particular probe for the whole experiment, eg. calibration constants    \\
\multicolumn{1}{c|}{Run-Probe Data}  & Yes            & Yes              & Data about a probe on a particular run, eg. positon or attenuation                  
\end{tabular}
\caption{Types of CSV spreadsheet as defined by the presence of the "run" and/or "probe" keywords.\label{csv_types}}
\end{table}




\section{Structure of the Package}
\input{structure}

\appendix 

\section{Metadata CSV Key Dictionary}
This appendix defines a number of dictionary keys.
\input{metadata_keys}


\end{document}